<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Bedtime Story Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
      .container { max-width: 820px; margin: 0 auto; }
      .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
      .title { font-size: 1.4rem; font-weight: 700; margin: 0 0 8px; }
      .btn { padding: 10px 16px; border-radius: 8px; border: 1px solid #1f2937; background: #111827; color: #fff; cursor: pointer; }
      .btn.secondary { background: #fff; color: #111827; }
      .btn[disabled] { opacity: 0.6; cursor: not-allowed; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      .muted { color: #6b7280; font-size: 0.9rem; }
      textarea, input[type="text"] { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; }
      .alert { padding: 10px 12px; border-radius: 8px; margin-bottom: 12px; }
      .alert.info { background: #eef2ff; color: #1e3a8a; }
      .alert.warning { background: #fef3c7; color: #92400e; }
      .alert.danger { background: #fee2e2; color: #991b1b; }

      /* Loading overlay + spinner */
      .overlay {
        position: fixed; inset: 0; background: rgba(255,255,255,0.8);
        display: none; align-items: center; justify-content: center; z-index: 9999;
      }
      .overlay.show { display: flex; }
      .spinner {
        width: 56px; height: 56px; border: 6px solid #e5e7eb; border-top-color: #111827;
        border-radius: 50%; animation: spin 1s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      .loading-text { margin-top: 12px; font-weight: 600; color: #111827; text-align: center; }
    </style>
  </head>
  <body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="overlay">
      <div style="display:flex; flex-direction:column; align-items:center;">
        <div class="spinner"></div>
        <div class="loading-text">Working‚Ä¶</div>
      </div>
    </div>

    <div class="container">
      <h1 class="title">üåô Bedtime Story Generator (Ages 5‚Äì10)</h1>
      <p class="muted">Enter a simple idea, we‚Äôll create a bedtime-safe story. Then tweak as much as you like.</p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert {{ category }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="card">
        <form id="generateForm" action="{{ url_for('generate') }}" method="post">
          <label for="prompt"><strong>Story idea</strong></label><br />
          <textarea id="prompt" name="prompt" rows="3" placeholder="e.g., An adventure about a cat and a water bottle, but calming at bedtime.">{{ state.prompt if state else "" }}</textarea>
          <div class="row" style="margin-top: 12px;">
            <button id="generateBtn" class="btn" type="submit">Generate Story</button>
          </div>
        </form>
        {% if state %}
          <!-- Reset form is OUTSIDE the generate form -->
          <form id="resetForm" action="{{ url_for('reset') }}" method="post" style="margin-top:10px;">
            <button class="btn secondary" type="submit">Reset</button>
          </form>
        {% endif %}
      </div>

      {% if state %}
        <div class="card">
          <div class="title">Your Story</div>
          <pre style="white-space: pre-wrap; font-family: inherit;">{{ state.story }}</pre>
        </div>

        <div class="card">
          <div class="title">Quality Check (Judge)</div>
          {% for r in state.history %}
            {% set v = r['verdict'] if r and 'verdict' in r else {} %}
            {% set scores = v['scores'] if v and 'scores' in v else {} %}
            <div class="muted">
              Round {{ r['round'] }} ‚Äî pass={{ v['pass'] if v and 'pass' in v else 'n/a' }} | avg={{ scores['average'] if scores and 'average' in scores else 'n/a' }}
            </div>
          {% endfor %}
        </div>

        <div class="card">
          <div class="title">Tweak the Story</div>
          <form id="tweakForm" action="{{ url_for('tweak') }}" method="post">
            <input type="text" id="tweakInput" name="tweak" placeholder="e.g., make it shorter and add a lullaby ending" />
            <div class="muted" style="margin: 6px 0 12px;">
              Try: ‚Äúshorter‚Äù, ‚Äúcalmer‚Äù, ‚Äúmore-dialogue‚Äù, ‚Äúnew-moral‚Äù, or any free text.
            </div>
            <button id="tweakBtn" class="btn" type="submit">Apply Tweak</button>
          </form>
        </div>
      {% endif %}
    </div>

    <script>
      // Show overlay + disable the clicked button
      function showLoading(msg, btn) {
        const overlay = document.getElementById('loadingOverlay');
        const text = overlay.querySelector('.loading-text');
        text.textContent = msg || 'Working‚Ä¶';
        overlay.classList.add('show');
        if (btn) {
          btn.setAttribute('data-original-text', btn.textContent);
          btn.textContent = 'Working‚Ä¶';
          btn.disabled = true;
        }
      }
    
      // Submit helper that ensures a paint happens before navigation
      function safeSubmit(form, msg, btn) {
        if (form.__submitting) return;        // guard against double submit
        form.__submitting = true;
        // Prevent default navigation right away
        // then allow a frame to render the overlay before we submit.
        showLoading(msg, btn);
        requestAnimationFrame(() => {
          // A tiny delay improves reliability on Safari/WebKit
          setTimeout(() => form.submit(), 40);
        });
      }
    
      // Hook up Generate
      const genForm = document.getElementById('generateForm');
      const genBtn  = document.getElementById('generateBtn');
      if (genForm && genBtn) {
        genForm.addEventListener('submit', function (e) {
          e.preventDefault();
          safeSubmit(genForm, 'Generating your story‚Ä¶', genBtn);
        });
      }
    
      // Hook up Tweak
      const tweakForm = document.getElementById('tweakForm');
      const tweakBtn  = document.getElementById('tweakBtn');
      if (tweakForm && tweakBtn) {
        tweakForm.addEventListener('submit', function (e) {
          e.preventDefault();
          safeSubmit(tweakForm, 'Applying your tweak‚Ä¶', tweakBtn);
        });
      }
    
      // Hook up Reset (optional)
      const resetForm = document.getElementById('resetForm');
      if (resetForm) {
        resetForm.addEventListener('submit', function (e) {
          e.preventDefault();
          safeSubmit(resetForm, 'Resetting‚Ä¶', null);
        });
      }
    </script>
    
  </body>
</html>
